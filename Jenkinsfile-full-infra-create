pipeline {
    agent any

    options {
        ansiColor('xterm')
    }

    stages {

        stage('VPC & DB') {
            steps {
                dir('vpc-n-db') {
                    git branch: 'main', url: 'https://github.com/praveenarupi/terraform-immutable-infra.git'
                    sh '''
            terrafile 
            terraform init -backend-config=env/prod-backend.tfvars
            terraform apply -auto-approve -var-file=env/prod.tfvars
          '''
                }
            }
        }

        stage('Backend Components') {
            parallel {

                stage('Cart') {
                    steps {
                        dir('cart') {
                            git branch: 'main', url: 'https://github.com/praveenarupi/cart-infra.git'
                            sh '''
            cd  immutable
            terrafile 
            terraform init -backend-config=env/prod-backend.tfvars
            terraform apply -auto-approve -var-file=env/prod.tfvars  
          '''
                        }
                    }
                }

                stage('Catalogue') {
                    steps {
                        dir('catalogue') {
                            git branch: 'main', url: 'https://github.com/praveenarupi/catalogue-infra.git'
                            sh '''
            cd  immutable
            terrafile 
            terraform init -backend-config=env/prod-backend.tfvars
            terraform apply -auto-approve -var-file=env/prod.tfvars 
          '''
                        }
                    }
                }

                stage('User') {
                    steps {
                        dir('user') {
                            git branch: 'main', url: 'https://github.com/praveenarupi/user-infra.git'
                            sh '''
            cd  immutable
            terrafile 
            terraform init -backend-config=env/prod-backend.tfvars
            terraform apply -auto-approve -var-file=env/prod.tfvars 
          '''
                        }
                    }
                }

                stage('Shipping') {
                    steps {
                        dir('shipping') {
                            git branch: 'main', url: 'https://github.com/praveenarupi/shipping-infra.git'
                            sh '''
            cd  immutable
            terrafile 
            terraform init -backend-config=env/prod-backend.tfvars
            terraform apply -auto-approve -var-file=env/prod.tfvars 
          '''
                        }
                    }
                }

                stage('Payment') {
                    steps {
                        dir('payment') {
                            git branch: 'main', url: 'https://github.com/praveenarupi/payment-infra.git'
                            sh '''
            cd  immutable
            terrafile 
            terraform init -backend-config=env/prod-backend.tfvars
            terraform apply -auto-approve -var-file=env/prod.tfvars 
          '''
                        }
                    }
                }


            }

        }

        stage('Frontend') {
            steps {
                dir('frontend') {
                    git branch: 'main', url: 'https://github.com/praveenarupi/frontend-infra.git'
                    sh '''
            cd  immutable
            terrafile 
            terraform init -backend-config=env/prod-backend.tfvars
            terraform apply -auto-approve -var-file=env/prod.tfvars 
          '''
                }
            }
        }



    }


}